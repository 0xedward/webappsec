<!DOCTYPE html>
<html>
  <head>
    <title>Content Security Policy</title>
    <meta http-equiv='Content-Type' content='text/html;charset=utf-8'/>
    <!--
      === NOTA BENE ===
      For the three scripts below, if your spec resides on dev.w3 you can check them
      out in the same tree and use relative links so that they'll work offline,
     -->
    <script src='js/respec.js' class='remove'></script>
    <script class='remove'>
      var respecConfig = {
          // specification status (e.g. WD, LCWD, NOTE, etc.). If in doubt use ED.
          // Member-SUBM
          specStatus:           "ED",

          // the specification's short name, as in http://www.w3.org/TR/short-name/
          shortName:            "CSP",

          // if your specification has a subtitle that goes below the main
          // formal title, define it here
          // subtitle   :  "an excellent document",

          // if you wish the publication date to be other than today, set this
          // publishDate:  "2009-08-06",

          // if the specification's copyright date is a range of years, specify
          // the start date here:
          copyrightStart: "2010",

          // if there is a previously published draft, uncomment this and set its YYYY-MM-DD date
          // and its maturity status
          // previousPublishDate:  "1977-03-15",
          // previousMaturity:  "WD",

          // if there a publicly available Editor's Draft, this is the link
          edDraftURI:           "http://dvcs.w3.org/hg/content-security-policy/raw-file/tip/csp-specification.dev.html",

          // if this is a LCWD, uncomment and set the end of its review period
          // lcEnd: "2009-08-05",

          // if you want to have extra CSS, append them to this list
          // it is recommended that the respec.css stylesheet be kept
          extraCSS:             ["css/respec.css"],

          // editors, add as many as you like
          // only "name" is required
          editors:  [
              { name: "Brandon Sterne", url: "mailto:bsterne@mozilla.com",
                company: "Mozilla Corporation", companyURL: "http://www.mozilla.com/" },
              { name: "Adam Barth", url: "mailto:w3c@adambarth.com",
                company: "Google, Inc.", companyURL: "http://www.google.com/" },
          ],

          // authors, add as many as you like. 
          // This is optional, uncomment if you have authors as well as editors.
          // only "name" is required. Same format as editors.

          //authors:  [
          //    { name: "Your Name", url: "http://example.org/",
          //      company: "Your Company", companyURL: "http://example.com/" },
          //],

          // name of the WG
          wg:           "Web Application Security Working Group",

          // URI of the public WG page
          wgURI:        "http://www.w3.org/2011/webappsec/",

          // name (with the @w3c.org) of the public mailing to which comments are due
          wgPublicList: "public-webappsec",

          // URI of the patent status for this WG, for Rec-track documents
          // !!!! IMPORTANT !!!!
          // This is important for Rec-track documents, do not copy a patent URI from a random
          // document unless you know what you're doing. If in doubt ask your friendly neighbourhood
          // Team Contact.
          wgPatentURI:  "http://www.w3.org/2004/01/pp-impl/49309/status",
      };
    </script>
  </head>
  <body>
    <section id="abstract">
      <p>This document defines a policy language used to declare a set of
      content restrictions for a web resource, and a mechanism for
      transmitting the policy from a server to a client where the policy is
      enforced.</p>
    </section>

    <section id="sotd">
      <p>Although a FPWD, this document describes a proposal that has been
      discussed by the broader community for about a year.  There are
      experimental implementations in Firefox and Chrome, using the header
      names <code>X-Content-Security-Policy</code> and
      <code>X-WebKit-CSP</code> respectively.  Internet Explorer 10 Platform
      Preview also contains a partial implementation, using the header name
      X-Content-Security-Policy.</p>

      <p>In addition to the documents in the W3C Web Application Security
      working group, the work on this document is also informed by the work of
      the <a href="http://tools.ietf.org/wg/websec/">IETF websec working
      group</a>, particularly that working group's requirements document:
      <a href="http://tools.ietf.org/id/draft-hodges-websec-framework-reqs">draft-hodges-websec-framework-reqs</a>.</p>
    </section>

    <section class="informative">
      <h2>Introduction</h2>

      <p>This document defines Content Security Policy, a mechanism web
      applications can use to mitigate the broad class of content injection
      vulnerabilities, such as cross-site scripting (XSS). Content Security
      Policy is a declarative policy that lets the authors (or server
      administrators) of a web application restrict from where the application
      can load resources.</p>

      <p>To mitigate XSS, for example, a web application can restrict itself
      to loading scripts only from known, trusted URIs, making it difficult
      for an attacker who can inject content into the web application to
      inject malicious script.</p>

      <p>Content Security Policy (CSP) is not intended as a first line of
      defense against content injection vulnerabilities. Instead, CSP is best
      used as defense-in-depth, to reduce the harm caused by content injection
      attacks.</p>

      <p>There is often a non-trivial amount of work required to apply CSP to
      an existing web application. To reap the greatest benefit, authors will
      need to move all inline script and style out-of-line, for example into
      external scripts, because the user agent cannot determine whether an
      inline script was injected by an attacker.</p>

      <p>To take advantage of CSP, a web application needs to opt into using
      CSP by supplying a Content-Security-Policy HTTP header or an appropriate
      HTML <code>meta</code> element. Such policies apply the current document
      only. To supply a policy for an entire site, the server need to supply a
      policy along with each resource representation.</p>
    </section>

    <section id="conformance">
      <p>Requirements phrased in the imperative as part of algorithms (such as
      "strip any leading space characters" or "return false and abort these
      steps") are to be interpreted with the meaning of the key word ("MUST",
      "SHOULD", "MAY", etc) used in introducing the algorithm.</p>

      <p>A conformant user-agent is one that implements all the requirements
      listed in this specification that are applicable to user-agents.</p>

      <p>A conformant server is one that implements all the requirements
      listed in this specification that are applicable to servers.</p>

      <section>
        <h3>Terminology</h3>

        <p>This section defines several terms used throughout the document.</p>

        <p>The term <dfn>security policy</dfn>, or
        simply <dfn>policy</dfn>, for the purposes of this
        specification refers to either:
          <ol>
            <li>a set of security preferences for restricting the behavior of
            content within a given document, or</li>
            <li>a fragment of text that codifies these preferences.</li>
          </ol>
        </p>

        <p>The security policies defined by this document are applied by a
        user-agent on a <em>per-resource representation basis</em>.
        Specifically, when a user agent receives a policy along with the
        representation of a given resource, that policy applies to <em>that
        resource representation only</em>. That resource representation is
        often referred to in this document as the <dfn>protected
        document</dfn>.

        <p>A server transmits its security policy for a particular resource as
        a collection of <dfn>directives</dfn>, such as <code>default-src
        'self'</code>, each of which controls a specific set of privileges for
        a document rendered by a user-agent. More details are provided in the
        <a href="#directives">directives</a> section.</p>

        <p>A directive consists of a <dfn>directive name</dfn>, which
        indicates the privileges controlled by the directive, and a
        <dfn>directive value</dfn>, which specifies the restrictions the
        policy imposes on those privileges.</p>

        <p>Fetching resources requires <dfn id="resolve">resolving</dfn>
        and <dfn id="parse-url">parsing</dfn> URLs.  The algorithms
        for <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/urls.html#resolving-urls">resolving
        a URL</a>
        and <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/urls.html#parse-a-url">parsing
        a URL</a> are defined in the HTML5 standard [[!HTML5]].</p>

        <p>The term <dfn>origin</dfn> is defined in the Origin specification.
        [<em><a href="http://tools.ietf.org/html/draft-ietf-websec-origin">ORIGIN</a></em>]</p>

        <p>The term <dfn>URI</dfn> is defined in the URI specification.  [[!URI]]</p>

        <p>The <code>&lt;script&gt;</code>, <code>&lt;object&gt;</code>, <code>&lt;embed&gt;</code>,
        <code>&lt;img&gt;</code>, <code>&lt;video&gt;</code>, <code>&lt;audio&gt;</code>,
        <code>&lt;link&gt;</code>, <code>&lt;frame&gt;</code> and <code>&lt;iframe&gt;</code>
        elements are defined in the HTML5 standard. [[!HTML5]].</p>

        <p>The <code>&lt;applet&gt;</code> element is defined in the HTML 4.01 standard. [[!HTML401]].</p>

        <p>The <code>@font-face</code> CSS rule is defined in the CSS Fonts Module Level 3 standard.
        [[!CSS3FONT]]</p>

        <p>The <code>XMLHttpRequest</code> object is defined in the <code>XMLHttpRequest</code>
        standard. [[!XMLHTTPREQUEST]]</p>

        <p>The <code>WebSocket</code> object is defined in the <code>WebSocket</code>
        standard. [<em><a href="http://dev.w3.org/html5/websockets/">WEBSOCKET</a></em>].</p>

        <p>The <code>EventSource</code> object is defined in the <code>EventSource</code>
        standard. [<em><a href="http://dev.w3.org/html5/eventsource/">EVENTSOURCE</a></em>].</p>

        <p>The Augmented Backus-Naur Form (ABNF) notation used in this
        document is specified in RFC 5234. [[!ABNF]]</p>

        <p>The following core rules are included by reference, as defined in
        [<em><a href="http://tools.ietf.org/html/rfc5234#appendix-B.1">ABNF Appendix B.1</a></em>]:
        <code>ALPHA</code> (letters), <code>DIGIT</code> (decimal
        0-9), <code>WSP</code> (white space) and <code>VCHAR</code> (printing
        characters).</p>
      </section>
    </section>

    <section>
      <h2>Framework</h2>

      <p>This section defines the general framework for content security
      policies, including the delivery mechanisms and general syntax for
      policies. The next section contains the details of the specific
      directives introduced in this specification.</p>

      <section>
        <h3>Policy Delivery</h3>

        <p>The policy can be delivered from the server to the client via an HTTP response header
        or an HTML <code>meta</code> element.</p>

        <p>Of the two delivery mechanisms, servers SHOULD use the HTTP
        response header mechanism whenever possible because, when using the
        <code>meta</code> element mechanism, there is a period of time between
        when the user agent begins to process the document and when the user
        agent encounters the <code>meta</code> element when the document is
        not protected by the policy.</p>

        <section>
          <h4><code>Content-Security-Policy</code> Header Field</h4>

          <p>The <code>Content-Security-Policy</code> header field is the
          preferred mechanism for delivering a CSP policy.</p>

          <p>A server MUST NOT send more than one HTTP header field named
          <code>Content-Security-Policy</code> with a given resource
          representation.  A server MAY send different
          <code>Content-Security-Policy</code> header field values with
          different representations of the same resource or with different
          resources.</p>

          <p>Upon receiving an HTTP response containing at least one
          <code>Content-Security-Policy</code> header field, the user agent
          MUST <a href="#enforce">enforce</a> the policy contained in the
          <em>first</em> such header field. The user agent MUST ignore
          subsequent such header fields.</p>
        </section>

        <section>
          <h4><code>Content-Security-Policy-Report-Only</code> Header Field</h4>

          <p>The <code>Content-Security-Policy-Report-Only</code> header field
          lets server experiment with CSP by monitoring (rather than
          enforcing) a policy. This feature lets server operators develop
          their security policy iteratively. They can deploy a report-only
          policy based on their best estimate of how their site behaves. If
          their site violates this policy, instead of breaking the site, the
          user agent will send violation reports to a URI specified in the
          policy. Once a site has confidence that the policy is appropriate,
          they can promote the report-only policy to normal blocking mode.</p>

          <p>A server MUST NOT send more than one HTTP header field named
          <code>Content-Security-Policy-Report-Only</code> with a given
          resource representation.  A server MAY send different
          <code>Content-Security-Policy-Report-Only</code> header field values
          with different representations of the same resource or with different
          resources.</p>

          <p>Upon receiving an HTTP response containing at least one
          <code>Content-Security-Policy-Report-Only</code> header field, the
          user agent MUST <a href="#monitor">monitor</a> the policy contained
          in the <em>first</em> such header field. The user agent MUST ignore
          subsequent such header fields.</p>

          <p class="note">A user agent might monitor one policy while
          enforcing another policy.</p>
        </section>

        <section>
          <h4>HTML <code>meta</code> Element</h4>

          <p>The server MAY supply a CSP policy in an HTML <code>meta</code>
          element with an <code>http-equiv</code> attribute that is a case
          insensitive match for either <code>Content-Security-Policy</code> or
          <code>Content-Security-Policy-Report-Only</code>.</p>

          <p>Add the following entries to the <a
          href="http://www.w3.org/TR/html5/semantics.html#pragma-directives">pragma
          directives</a> for the <code>meta</code> element:</p>

          <dl>
            <dt>Content security policy (<code>http-equiv="content-security-policy"</code>)</dt>
            <dd>
              <ol>
                <li>If the user agent is already enforcing a CSP policy for the
                document, abort these steps.</li>

                <li>If the <code>meta</code> element lacks a
                <code>content</code> attribute, abort these steps.</li>

                <li><a href="#enforce">Enforce</a> the CSP policy contained in
                the <code>content</code> attribute of the <code>meta</code>
                element.</li>
              </ol>
            </dd>

            <dt>Content security policy, report only (<code>http-equiv="content-security-policy-report-only"</code>)</dt>
            <dd>
              <ol>
                <li>If the user agent is already monitoring a CSP policy for
                the document, abort these steps.</li>

                <li>If the <code>meta</code> element lacks a
                <code>content</code> attribute, abort these steps.</li>

                <li><a href="#monitor">Monitor</a> the CSP policy contained in
                the <code>content</code> attribute of the <code>meta</code>
                element.</li>
              </ol>
            </dd>
          </dl>
        </section>
      </section>

      <section>
        <h3>Syntax</h3>

        <section>
          <h4>Policies</h4>

          <p>A CSP <dfn>policy</dfn> consists of a U+003B SEMICOLON
          (<code>;</code>) delimited list of directives:</p>

<pre>
policy            = directive-list
directive-list    = [ directive *( ";" [ directive ] ) ]
</pre>

          <p>Each <dfn>directive</dfn> consists of a <var>directive-name</var>
          and (optionally) a <var>directive-value</var>:</p>

<pre>
directive         = *WSP [ directive-name [ WSP directive-value ] ]
directive-name    = 1*( ALPHA / DIGIT / "-" )
directive-value   = *( WSP / &lt;VCHAR except ";"&gt; )
</pre>

          <p>To <dfn id="parse-a-csp-policy">parse a CSP policy</dfn>
          <var>policy</var>, the user agent MUST use an algorithm equivalent to
          the following:</p>

          <ol>
            <li>Let the <var>set of directives</var> be the empty set.</li>

            <li>For each non-empty token returned by <a
            href="http://www.w3.org/TR/html5/common-microsyntaxes.html#strictly-split-a-string">strictly
            splitting</a> the string <var>policy</var> on the character U+003B
            SEMICOLON (<code>;</code>):
              <ol>
                <li><a href="http://www.w3.org/TR/html5/common-microsyntaxes.html#skip-whitespace">Skip whitespace</a>.</li>

                <li><a href="http://www.w3.org/TR/html5/common-microsyntaxes.html#collect-a-sequence-of-characters">Collect
                a sequence of characters</a> that are not
                <a href="http://www.w3.org/TR/html5/common-microsyntaxes.html#space-character">space characters</a>. The
                collected characters are the <var>directive name</var>.</li>

                <li>If <var>position</var> doesn't point past the end of the
                token, skip ahead one character (which must be a <a
                href="http://www.w3.org/TR/html5/common-microsyntaxes.html#space-character">space
                character</a>).</li>

                <li>The remaining characters in <var>token</var> (if any) are
                the <var>directive value</var>.</li>

                <li>If the <var>set of directives</var> already contains a
                directive with name <var>directive name</var>, ignore this
                instance of the directive and continue to the next token.</li>

                <li>Add a <var>directive</var> to the <var>set of
                directives</var> with name <var>directive name</var> and value
                <var>directive value</var>.</li>
              </ol>
            </li>

            <li>Return the <var>set of directives</var>.
          </ol>
        </section>

        <section>
          <h4>Source List</h4>

          <p>Many CSP directives use a value consisting of a <dfn>source
          list</dfn>.</p>

          <p>Each <dfn>source expression</dfn> in the source list represents a
          location from which content of the specified type can be retrieved.
          For example, the source expression <code>'self'</code> represents
          the set of URIs which are in the same origin as the protected
          document and the source expression <code>'unsafe-inline'</code>
          represents content supplied inline in the document itself.</p>

<pre>
source-list       = *WSP [ source-expression *( 1*WSP source-expression ) *WSP ]
                  / *WSP "'none'" *WSP
source-expression = scheme-source / host-source / keyword-source
scheme-source     = scheme ":"
host-source       = ( [ scheme "://" ] host [ port ] )
keyword-source    = "'self'" / "'unsafe-inline'" / "'unsafe-eval'"
scheme            = &lt;scheme&gt; production from RFC 3986
host              = "*" / [ "*." ] 1*host-char *( "." 1*host-char )
host-char         = ALPHA / DIGIT / "-"
port              = ":" ( 1*DIGIT / "*" )
</pre>

          <p>To <dfn id="parse-a-source-list">parse a source list</dfn>
          <var>source list</var>, the user agent MUST use an algorithm
          equivalent to the following:</p>

          <ol>
            <li>If <var>source list</var> (with <a href="http://www.w3.org/TR/html5/common-microsyntaxes.html#strip-leading-and-trailing-whitespace">leading
            and trailing whitespace stripped</a>) is a case insensitive match
            for the string <code>'none'</code> (including the quotation
            marks), return the empty set.</li>

            <li>Let the <var>set of source expressions</var> be the empty set.</li>

            <li>For each token returned by <a href="http://www.w3.org/TR/html5/common-microsyntaxes.html#split-a-string-on-spaces">splitting
            <var>source list</var> on spaces</a>, if the token matches the
            grammar for <code>source-expression</code>, add the token to the
            <var>set of source expressions</var>.</li>

            <li>Return the <var>set of source expressions</var>.</li>
          </ol>

          <p>To check whether a URI <dfn
          id="matches-a-source-expression">matches a source expression</dfn>,
          the user agent MUST use an algorithm equivalent to the
          following:</p>

          <ol>
            <li>If the source expression a single U+002A ASTERISK character
            (<code>*</code>), then return <em>does match</em>.</li>

            <li>If the source expression matches the grammar for
            <code>scheme-source</code>, then the URI matches the source
            expression of the URI's scheme is a case-insensitive match for the
            source expression's <code>scheme</code>.</li>

            <li>Otherwise, if the source expression matches the grammar for
            <code>host-source</code>:
              <ol>
                <li>If the URI does not contain a host, then return <em>does
                not match</em>.</li>

                <li>Let <var>scheme</var>, <var>host</var>, and
                <var>port</var> be the scheme, host, and port of the URI,
                respectively. If the URI does not have a port, then let
                <var>port</var> be the default port for
                <var>scheme</var>.</li>

                <li>If the source expression has a <code>scheme</code> that is
                not a case insensitive match for <var>scheme</var>, then
                return <em>does not match</em>.</li>

                <li>If <var>scheme</var> is not a case insensitive match for
                the scheme of the protected document's URI, then return
                <em>does not match</em>.<br>
                <em>FIXME: Should we allow HTTPS when the document's scheme is
                HTTP?</em></li>

                <li>If the first character of the source expression's
                <code>host</code> is an U+002A ASTERISK character
                (<code>*</code>) and the remaining characters, including the
                leading U+002E FULL STOP character (<code>.</code>), are not a
                case insensitive match for the rightmost characters of
                <var>host</var>, then return <em>does not match</em>.</li>

                <li>If <var>host</var> is not a case insensitive match for the
                source expression's <code>host</code>, then return <em>does
                not match</em>.</li>

                <li>If the source expression does not contain a
                <code>port</code> and <var>port</var> is not the default port
                for <var>scheme</var>, then return <em>does not
                match</em>.</li>

                <li>If the source expression does contain a <code>port</code>
                that (a) does <em>not</em> contain an U+002A ASTERISK
                character (<code>*</code>) and (b) does <em>not</em> represent
                the same number as <var>port</var>, then return <em>does not
                match</em>.</li>

                <li>Return <em>does match</em>.</li>
              </ol>

              <li>Otherwise, if the source expression is a case insensitive
              match for <code>'self'</code> (including the quotation marks),
              then return the URI matches the source expression if the URI has
              the same scheme, host, and port as the document's URI.</li>

              <li>Otherwise, the URI does not match the source expression.</li>
            </li>
          </ol>

          <p>A URI <dfn id="matches-a-source-list">matches a source
          list</dfn>, if, and only if, the URI <a
          href="#matches-a-source-expression">matches at least one source
          expression</a> in the set of source expressions obtained by <a
          href="#parse-a-source-list">parsing the source list</a>. Notice that
          no URIs match an empty set of source expressions, such as the set
          obtained by parsing the source list <code>'none'</code>.</p>
        </section>
      </section>

      <section>
        <h3>Processing Model</h3>

        <p>To <dfn id="enforce">enforce</dfn> a CSP policy, the user agent MUST
        <a href="#parse-a-csp-policy">parse the policy</a> and enforce each of
        the directives contained in the policy, where the specific
        requirements for enforcing each directive are defined separately for
        each directive (See <a href="#sec-directives">Directives</a>,
        below).</p>

        <p>Generally speaking, enforcing a directive prevent the protected
        document from performing certain actions, such as loading scripts from
        URIs other than those indicated in a source list. These restrictions
        make it more difficult for an attacker to abuse an injection
        vulnerability in the document because the attacker will be unable to
        usurp the document's privileges that have been restricted in this
        way.</p>

        <p>Enforcing a CSP policy SHOULD NOT interfere with the operation of
        user-supplied scripts such as third-party user-agent add-ons and
        JavaScript bookmarklets.</p>

        <p>To <dfn id="monitor">monitor</dfn> a CSP policy, the user agent MUST
        <a href="#parse-a-csp-policy">parse the policy</a> and monitor each of
        the directives contained in the policy, where the specific
        requirements for monitoring each directive are defined separately for
        each directive (See <a href="#sec-directives">Directives</a>,
        below).</p>

        <p>Generally speaking, monitoring a directive does not prevent the
        protected document from undertaking any actions. Instead, any actions
        that would have been prevented by the directive are instead reported
        to the developer of the web application. Monitoring a CSP policy is
        most useful for testing whether enforcing the policy will break the
        web application.</p>

        <p>If the user agent monitors or enforces a CSP policy that does not
        contain any directives, the user agent SHOULD report a warning message
        in the developer console.</p>

        <p>If the user agent monitors or enforces a CSP policy that contains
        an unrecognized directive, the user agent SHOULD report a warning
        message in the developer console indicating the name of the
        unrecognized directive.</p>

        <p>Whenever a user agent <a
        href="http://www.w3.org/TR/workers/#run-a-worker">runs a worker</a>:
        </p>

        <ul>
          <li>If the user agent is enforcing a CSP policy for the <var>owner
          document</var>, the user agent MUST enforce the CSP policy for the
          worker.</li>

          <li>If the user agent is monitoring a CSP policy for the <var>owner
          document</var>, the user agent MUST monitor the CSP policy for the
          worker.</li>
        </ul>
      </section>
    </section>

    <section>
      <h2 id="sec-directives">Directives</h2>

      <p>This section describes the content security policy directives
      introduced in this specification.</p>

      <p>In order to protect against Cross-site Scripting (XSS), authors
      SHOULD include
      <ul>
        <li>both the <code>script-src</code> and <code>object-src</code>
        directives, or</li>

        <li>include a <code>default-src</code> directive, which covers both
        scripts and plug-ins.</li>
      </ul>

      <p>In either case, authors SHOULD NOT include
      <code>'unsafe-inline'</code> in their CSP policies if they wish to
      protect themselves against XSS.</p>

      <section>
        <h3><code>default-src</code></h3>

        <p>The <code>default-src</code> directive sets a default source list
        for a number of directives. The syntax for the name and value of the
        directive are described by the following ABNF grammar:</p>

<pre>
directive-name    = "default-src"
directive-value   = source-list
</pre>

        <p>Let the <var>default sources</var> be the result of <a
        href="#parse-a-source-list">parsing the directive's value as a
        source list</a>.</p>

        <p>To enforce the <code>default-src</code> directive, the user agent
        MUST enforce the following directives:</p>
        <ul>
          <li>script-src</li>
          <li>object-src</li>
          <li>style-src</li>
          <li>img-src</li>
          <li>media-src</li>
          <li>frame-src</li>
          <li>font-src</li>
          <li>connect-src</li>
        </ul>

        <p>If not specified explicitly in the policy, the directives listed
        above will use the <var>default sources</var>.</p>
      </section>

      <section>
        <h3><code>script-src</code></h3>

        <p>The <code>script-src</code> directive restricts which scripts the
        protected document can execute. The directive also controls other
        resources, such as XSLT stylesheets, which can cause the user agent to
        execute script. The syntax for the name and value of the directive are
        described by the following ABNF grammar:</p>

<pre>
directive-name    = "script-src"
directive-value   = source-list
</pre>

        <p>If the policy contains an explicit <code>script-src</code>, let the
        <var>allowed script sources</var> be the result of <a
        href="#parse-a-source-list">parsing the directive's value as a source
        list</a>. Otherwise, let the <var>allowed script sources</var> be the
        <var>default sources</var></p>

        <p>If <code>'unsafe-inline'</code> is not in <var>allowed script
        sources</var>:</p>
        <ul>
          <li>Whenever the user agent would execute an inline script (either
          from a <code>script</code> element or from an inline event handler),
          instead the user agent MUST NOT execute script.</li>

          <li>Whenever the user agent would execute script contained in a
          <code>javascript</code> URI, instead the user agent MUST NOT execute
          the script. (Note: The user agent SHOULD execute script contained in
          "bookmarklets" even when enforcing this restriction.)</li>
        </ul>

        <p>If <code>'unsafe-eval'</code> is not in <var>allowed script
        sources</var>:</p>
        <ul>
          <li>Instead of evaluating their arguments, both operator
          <code>eval</code> and function <code>eval</code> MUST throw a
          security exception.</li>

          <li>When called as a constructor, the function <code>Function</code>
          MUST throw a security exception.</li>

          <li>When called with a first argument that is non-callable (e.g.,
          not a function), the <code>setTimeout</code> function MUST return
          zero without creating a timer.</li>

          <li>When called with a first argument that is non-callable (e.g.,
          not a function), the <code>setInterval</code> function MUST return
          zero without creating a timer.</li>
        </ul>

        <p>The term <dfn>callable</dfn> refers to an object whose interface
        has one or more <dfn>callers</dfn> as defined in the <a
        href="http://www.w3.org/TR/2010/WD-WebIDL-20101021/#idl-callers">Web
        IDL</a> specification [[!WEBIDL]].</p>

        <p>Whenever the user agent <a
        href="http://www.w3.org/TR/html5/fetching-resources.html#fetch">fetches</a>
        a URI (including when following redirects) in the course of one of the
        following activities, if the URI does not <a
        href="#matches-a-source-list">match the <var>allowed script
        sources</var></a>, the user agent MUST act as if it had received an empty
        HTTP 400 response:</p>
        <ul>
          <li>Requesting a script, such as when processing the
          <code>src</code> attribute of a <code>script</code> element or when
          processing the <code>Worker</code> or <code>SharedWorker</code>
          constructors.</li>

          <li>Requesting an Extensible Stylesheet Language Transformations
          (XSLT), such as when processing the
          <code>&lt;?xml-stylesheet?&gt;</code> processing directive in an XML
          document, the <code>href</code> attributes on
          <code>&lt;xsl:include&gt;</code> element, or the <code>href</code>
          attributes on <code>&lt;xsl:import&gt;</code> element.</li>
        </ul>
      </section>
      <section>
        <h3><code>object-src</code></h3>

        <p>The <code>object-src</code> directive restricts from where the
        protected document can load plugins. The syntax for the name and value
        of the directive are described by the following ABNF grammar:</p>

<pre>
directive-name    = "object-src"
directive-value   = source-list
</pre>

        <p>If the policy contains an explicit <code>object-src</code>, let the
        <var>allowed object sources</var> be the result of <a
        href="#parse-a-source-list">parsing the directive's value as a source
        list</a>. Otherwise, let the <var>allowed object sources</var> be the
        <var>default sources</var></p>

        <p>Whenever the user agent <a
        href="http://www.w3.org/TR/html5/fetching-resources.html#fetch">fetches</a>
        a URI (including when following redirects) in the course of one of the
        following activities, if the URI does not <a
        href="#matches-a-source-list">match the <var>allowed object
        sources</var></a>, the user agent MUST act as if it had received an empty
        HTTP 400 response:</p>
        <ul>
          <li>Requesting data for a plugin, such as when processing the
          <code>data</code> attribute of an <code>object</code> element, the
          <code>src</code> attribute of an <code>embed</code> elements, or the
          <code>code</code> or <code>archive</code> attributes of an
          <code>applet</code> element.</li>

          <li>Requesting data for display in a nested browsing context in the
          protected document created by an <code>object</code> or an
          <code>embed</code> element.</li>

          <li>Navigating such a nested browsing context.</li>
        </ul>

        <p>It is not required that the consumer of the element's data be a
        plugin in order for the <code>object-src</code> directive to be
        enforced.  Data for any <code>object</code>, <code>embed</code>,
        or <code>applet</code> element MUST match the <var>allowed object
        sources</var> in order to be fetched.  This is true even when the
        element data is semantically equivalent to content which would be
        restricted by one of the other <a href="#directives">directives</a>,
        such as an <code>object</code> element with a <code>text/html</code>
        MIME type.</p>

        <p>Whenever the user agent would load a plug-in without an associated
        URI (e.g., because the <code>object</code> element lacked a
        <code>data</code> attribute), if the protected document's URI does not
        <a href="#matches-a-source-list">match the <var>allowed object
        sources</var></a>, the user agent MUST NOT load the plug-in.</p>
      </section>

      <section>
        <h4><code>style-src</code></h4>

        <p>The <code>style-src</code> directive restricts which styles the
        user applies to the protected document. The syntax for the name and
        value of the directive are described by the following ABNF
        grammar:</p>

<pre>
directive-name    = "style-src"
directive-value   = source-list
</pre>


        <p>If the policy contains an explicit <code>style-src</code>, let the
        <var>allowed style sources</var> be the result of <a
        href="#parse-a-source-list">parsing the directive's value as a source
        list</a>. Otherwise, let the <var>allowed style sources</var> be the
        <var>default sources</var></p>

        <p>If <code>'unsafe-inline'</code> is not in <var>allowed style
        sources</var>:</p>
        <ul>
          <li>Whenever the user agent would apply style from a
          <code>style</code> element, instead the user agent <code>MUST</code>
          ignore the style.</li>

          <li>Whenever the user agent would apply style from a
          <code>style</code> attribute, instead the user agent
          <code>MUST</code> ignore the style.</li>
        </ul>

        <p>Note: These restrictions on inline do not prevent the user agent
        from applying style from an external stylesheet (e.g., found via
        <code>&lt;link rel="stylesheet"&gt;</code>). The user agent is also
        not prevented from applying style from CSSOM.</p>

        <p>Whenever the user agent <a
        href="http://www.w3.org/TR/html5/fetching-resources.html#fetch">fetches</a>
        a URI (including when following redirects) in the course of one of the
        following activities, if the URI does not <a
        href="#matches-a-source-list">match the <var>allowed style
        sources</var></a>, the user agent MUST act as if it had received an empty
        HTTP 400 response:</p>
        <ul>
          <li>Requesting external stylesheets, such as when processing the
          <code>href</code> attribute of a <code>link</code> element with a
          <code>rel</code> attribute containing the token
          <code>stylesheet</code> or when processing the <code>@import</code>
          directive in a stylesheet.</li>
        </ul>

        <p>Note: The <code>style-src</code> directive does not restrict the
        use of XSLT. XSLT is restricted by the <code>script-src</code>
        directive because the security consequences of including an untrusted
        XSLT stylesheet are similar to those incurred by including an
        untrusted script.</p>
      </section>

      <section>
        <h4><code>img-src</code></h4>

        <p>The <code>img-src</code> directive restricts from where the
        protected document can load images. The syntax for the name and value
        of the directive are described by the following ABNF grammar:</p>

<pre>
directive-name    = "img-src"
directive-value   = source-list
</pre>

        <p>If the policy contains an explicit <code>img-src</code>, let the
        <var>allowed image sources</var> be the result of <a
        href="#parse-a-source-list">parsing the directive's value as a source
        list</a>. Otherwise, let the <var>allowed image sources</var> be the
        <var>default sources</var></p>

        <p>Whenever the user agent <a
        href="http://www.w3.org/TR/html5/fetching-resources.html#fetch">fetches</a>
        a URI (including when following redirects) in the course of one of the
        following activities, if the URI does not <a
        href="#matches-a-source-list">match the <var>allowed image
        sources</var></a>, the user agent MUST act as if it had received an empty
        HTTP 400 response:</p>
        <ul>
          <li>Requesting data for an image, such as when processing the
          <code>src</code> attribute of an <code>img</code> elements,
          the <code>url()</code> or <code>image()</code> values on any CSS
          property that is capable of loading an image [<em><a
          href="http://www.w3.org/TR/css3-images/">CSS3-Images</a></em>], or
          the <code>href</code> attribute of a <code>link</code> element with
          an image-related <code>rel</code> attribute, such as
          <code>icon</code>.</li>
        </ul>
      </section>

      <section>
        <h4><code>media-src</code></h4>

        <p>The <code>media-src</code> directive restricts from where the
        protected document can load video and audio. The syntax for the name
        and value of the directive are described by the following ABNF
        grammar:</p>

<pre>
directive-name    = "media-src"
directive-value   = source-list
</pre>

        <p>If the policy contains an explicit <code>media-src</code>, let the
        <var>allowed media sources</var> be the result of <a
        href="#parse-a-source-list">parsing the directive's value as a source
        list</a>. Otherwise, let the <var>allowed media sources</var> be the
        <var>default sources</var></p>

        <p>Whenever the user agent <a
        href="http://www.w3.org/TR/html5/fetching-resources.html#fetch">fetches</a>
        a URI (including when following redirects) in the course of one of the
        following activities, if the URI does not <a
        href="#matches-a-source-list">match the <var>allowed media
        sources</var></a>, the user agent MUST act as if it had received an empty
        HTTP 400 response:</p>
        <ul>
          <li>Requesting data for a video or audio clip, such as when
          processing the <code>src</code> attribute of a <code>video</code>
          or <code>audio</code> elements.</li>
        </ul>
      </section>

      <section>
        <h4><code>frame-src</code></h4>

        <p>The <code>frame-src</code> directive restricts from where the
        protected document can embed frames. The syntax for the name
        and value of the directive are described by the following ABNF
        grammar:</p>

<pre>
directive-name    = "frame-src"
directive-value   = source-list
</pre>

        <p>If the policy contains an explicit <code>frame-src</code>, let the
        <var>allowed frame sources</var> be the result of <a
        href="#parse-a-source-list">parsing the directive's value as a source
        list</a>. Otherwise, let the <var>allowed frame sources</var> be the
        <var>default sources</var></p>

        <p>Whenever the user agent <a
        href="http://www.w3.org/TR/html5/fetching-resources.html#fetch">fetches</a>
        a URI (including when following redirects) in the course of one of the
        following activities, if the URI does not <a
        href="#matches-a-source-list">match the <var>allowed frame
        sources</var></a>, the user agent MUST act as if it had received an empty
        HTTP 400 response:</p>
        <ul>
          <li>Requesting data for display in a nested browsing context in the
          protected document created by an <code>iframe</code> or
          a <code>frame</code> element.</li>

          <li>Navigating such a nested browsing context.</li>
        </ul>
      </section>

      <section>
        <h4><code>font-src</code></h4>

        <p>The <code>font-src</code> directive restricts from where the
        protected document can load fonts. The syntax for the name and value
        of the directive are described by the following ABNF grammar:</p>

<pre>
directive-name    = "font-src"
directive-value   = source-list
</pre>

        <p>If the policy contains an explicit <code>font-src</code>, let the
        <var>allowed font sources</var> be the result of <a
        href="#parse-a-source-list">parsing the directive's value as a source
        list</a>. Otherwise, let the <var>allowed font sources</var> be the
        <var>default sources</var></p>

        <p>Whenever the user agent <a
        href="http://www.w3.org/TR/html5/fetching-resources.html#fetch">fetches</a>
        a URI (including when following redirects) in the course of one of the
        following activities, if the URI does not <a
        href="#matches-a-source-list">match the <var>allowed font
        sources</var></a>, the user agent MUST act as if it had received an empty
        HTTP 400 response:</p>
        <ul>
          <li>Requesting data for display in a font, such as when processing
          the <code>@font-face</code> CSS rule. <em>TODO: Citation needed.</em></li>
        </ul>
      </section>

      <section>
        <h4><code>connect-src</code></h4>

        <p>The <code>connect-src</code> directive restricts which URIs the
        protected document can load using DOM APIs. The syntax for the name
        and value of the directive are described by the following ABNF
        grammar:</p>

<pre>
directive-name    = "connect-src"
directive-value   = source-list
</pre>

        <p>If the policy contains an explicit <code>connect-src</code>, let
        the <var>allowed connection targets</var> be the result of <a
        href="#parse-a-source-list">parsing the directive's value as a source
        list</a>. Otherwise, let the <var>allowed connection targets</var> be
        the <var>default sources</var></p>

        <p>Whenever the user agent <a
        href="http://www.w3.org/TR/html5/fetching-resources.html#fetch">fetches</a>
        a URI (including when following redirects) in the course of one of the
        following activities, if the URI does not <a
        href="#matches-a-source-list">match the <var>allowed font
        sources</var></a>, the user agent MUST act as if it had received an empty
        HTTP 400 response:</p>
        <ul>
          <li>Processing the <a
          href="http://www.w3.org/TR/XMLHttpRequest/#the-open-method"><code>open()</code>
          method</a> of an <code>XMLHttpRequest</code> object.</li>

          <li>Processing the <a
          href="http://dev.w3.org/html5/websockets/#websocket"><code>WebSocket</code>
          constructor</a>.</li>

          <li>Processing the <a
          href="http://dev.w3.org/html5/eventsource/#eventsource"><code>EventSource</code>
          constructor</a>.</li>
        </ul>
      </section>

      <section>
        <h4><code>sandbox</code></h4>

        <p>The <code>sandbox</code> directive specifies an HTML sandbox policy
        that the user agent applies to the protected document. The syntax for
        the name and value of the directive are described by the following
        ABNF grammar:</p>

<pre>
directive-name    = "sandbox"
directive-value   = token *( 1*WSP token )
token             = &lt;token from RFC 2616&gt;
</pre>

        <p>When enforcing the <code>sandbox</code> directive, the user agent
        MUST set the <a href="http://www.w3.org/TR/html5/the-iframe-element.html#attr-iframe-sandbox">sandbox
        flags</a> for the protected document as if the document where
        contained in a nested browsing context within a document with sandbox
        flags given by the <code>directive-value</code>.</p>

        <p class="issue">The <code>sandbox</code> directive might be removed
        from a future version of this document. See <a
        href="http://www.w3.org/2011/webappsec/track/issues/6">ISSUE-6</a>.</p>
      </section>

      <section>
        <h4><code>report-uri</code></h4>

        <p>The <code>report-uri</code> directive specifies a URI to which the
        user agent sends reports about policy violation. The syntax for the
        name and value of the directive are described by the following ABNF
        grammar:</p>

<pre>
directive-name    = "report-uri"
directive-value   = uri-reference *( 1*WSP uri-reference )
uri-reference     = &lt;URI-reference from RFC 3986&gt;
</pre>

        <p>Let the <var>set of report URIs</var> be the value of the
        <code>report-uri</code> directive, each resolved relative to the
        protected document's URI.</p>

        <p>To <dfn id="send-a-violation-report">send a violation report</dfn>,
        the user agent MUST use an algorithm equivalent to the following:</p>
        <ol>
          <li>Prepare a dictionary <var>violation dictionary</var> with the
          following keys and values:
            <dl>
              <dt>request</dt>
              <dd>HTTP request line of the protected resource whose policy was
              violated including method, URI and HTTP version</dd>

              <dt>blocked-uri</dt>
              <dd>URI of the resource that was prevented from loading due to
              the policy violation</dd>

              <dt>violated-directive</dt>
              <dd>The policy directive that was violated</dd>

              <dt>original-policy</dt>
              <dd>The original policy as received by the user-agent.</dd>
            </dl>
          </li>

          <li>If the origin of the blocked-uri is not the same as the
          document's origin, then replace the blocked-uri with the ASCII
          serialization of the blocked-uri's origin.</li>

          <li>Let the <var>violation report</var> be the JSON stringification
          of the <var>violation dictionary</var>.</li>

          <li>For each <var>report URI</var> in the <var>set of report URIs</var>:
            <ol>
              <li>If the <var>report URI</var> has a different scheme than the
              URI of the protected document, then ignore this <var>report
              URI</var> and continue to the next iteration of the loop.</li>

              <li>If the <var>report URI</var> has a different port than the
              URI of the protected document, then ignore this <var>report
              URI</var> and continue to the next iteration of the loop.</li>

              <li>If the <var>report URI</var>'s host does not share the same
              <em><a href="http://publicsuffix.org/">public suffix</a> +1 DNS
              label</em> as the URI of the protected document, then ignore
              this <var>report URI</var> and continue to the next iteration of
              the loop.

              <p>Examples of public suffixes include <code>.com</code>,
              <code>.net</code> and <code>.co.uk</code>. Examples of
              <em>"public suffix +1 DNS label"</em> include
              <code>example.com</code>, <code>example.net</code> and
              <code>example.co.uk</code>. Therefore a protected document whose
              host is <code>www.example.com</code> could have a
              <code>report-uri</code> hosted on
              <code>reports.example.com</code> but <b>not</b>
              <code>reports.example.net</code>.</p></li>

              <li>Fetch the <var>report URI</var> from origin of the protected
              document, with the synchronous flag <em>not</em> set, using HTTP
              method <code>POST</code>, with a <code>Content-Type</code>
              header field of <code>application/json</code> with an entity
              body consisting of the <var>violation report</var>. The user
              agent MUST NOT follow redirects when fetching this resource.
              (Note: The user agent ignores the fetched resource.)</li>
            </ol>
          </li>
        </ol>
      </section>

      <section>
        <h4><code>policy-uri</code></h4>

        <p>The <code>policy-uri</code> directive specifies a URI from which
        the user agent can retrieve the actual policy. The syntax for the name
        and value of the directive are described by the following ABNF
        grammar:</p>

<pre>
directive-name    = "policy-uri"
directive-value   = &lt;URI-reference from RFC 3986&gt;
</pre>

        <p class="issue">The <code>policy-uri</code> directive might be
        removed from this document.</p>

        <p>Authors MUST NOT specify policies that contain both a
        <code>policy-uri</code> directive and another directive.</p>

        <p>If the user agent would enforce a policy containing both the
        <code>policy-uri</code> directive and another directive, instead the
        user agent MUST enforce the policy <code>default-src
        'none'</code>.</p>

        <p>When processing the <code>policy-uri</code> directive, the user
        agent MUST run an algorithm equivalent to the following:</p>
        <ul>
          <li>Let <var>request URI</var> be the URI that results from
          resolving the value of the <code>policy-uri</code> directive
          relative to the URI of the protected document.</li>

          <li>If <var>request URI</var> is not from the same origin as the
          protected document, abort these steps and enforce the policy
          <code>default-src 'none'</code>.

          <li>Fetch the <var>request URI</var> from origin of the protected
          document, with the synchronous flag set, using HTTP method
          <code>GET</code>.</li>

          <li>If the fetch returned a status code other than <code>200</code>
          or if the request encountered an HTTP redirect, abort these steps
          and enforce the policy <code>default-src 'none'</code>.</li>

          <li>If the fetched resource lacks a <code>Content-Type</code> header
          field or if the <code>Content-Type</code> header field is not a case
          insensitive match for <code>text/x-content-security-policy</code>,
          abort these steps and enforce the policy <code>default-src
          'none'</code>.</li>

          <li>Let the <var>fetched policy</var> be the result of <a
          href="#parse-a-csp-policy">parsing the fetched resource as a CSP
          policy</a>.</li>

          <li>If the <var>fetched policy</var> contains a
          <code>policy-uri</code> directive, abort these steps and enforce the
          policy <code>default-src 'none'</code>.</li>

          <li><a href="#enforce">Enforce</a> the <var>fetched
          policy</var>.</li>
        </ul>
      </section>
    </section>

    <section>
      <h2>Examples</h2>

      <section class="informative">
        <h3>Sample Policy Definitions</h3>

        <p>This section provides some sample use cases and accompanying security policies.</p>

        <p><strong>Example 1:</strong> A server wishes to load resources only
        form its own origin:</p>

        <pre>Content-Security-Policy: default-src 'self'</pre>

        <p><strong>Example 2:</strong> An auction site wishes to load images
        from any URI, plug-in content from a list of trusted media providers
        (including a content distribution network), and scripts only from a
        server under its control hosting sanitized ECMAScript:</p>

        <pre>Content-Security-Policy: default-src 'self'; img-src *;
                         object-src media1.example.com media2.example.com *.cdn.example.com;
                         script-src trustedscripts.example.com</pre>

        <p><strong>Example 3:</strong> Online banking site wishes to ensure that all of the content
        in its pages is loaded over TLS to prevent attackers from eavesdropping on insecure content
        requests:</p>

        <pre>Content-Security-Policy: default-src https: 'unsafe-inline' 'unsafe-eval'</pre>
      </section>

      <section class="informative">
        <h3>Sample Violation Report</h3>

        <p>This section contains an example violation report the user agent
        might sent to a server when the protected document violations a sample
        policy.</p>

        <p>In the following example, a document from
        <code>http://example.org/page.html</code> was rendered with the
        following CSP policy:</p>

<pre>default-src 'self'; report-uri http://example.org/csp-report.cgi</pre>

        <p>The document loaded an image from
        <code>http://evil.example.com/image.png</code>, violating the
        policy.</p>

        <pre>{
  "csp-report": {
    "request": "GET http://example.org/page.html HTTP/1.1",
    "blocked-uri": "http://evil.example.com/image.png",
    "violated-directive": "default-src http://example.org",
    "original-policy": "default-src 'self'; report-uri http://example.org/csp-report.cgi"
  }
}</pre>

        <p>In the above sample report the <code>violated-directive</code>
        field was sent in the way it was interpreted by the user-agent. The
        directive was made explicit by replacing the keyword
        <code>'self'</code> with the explicit host name of the protected
        resource. This is recommended behavior for user-agents as it reduces
        ambiguity, making policy violations easier to trace by server
        admins.</p>

        <p class="issue">Should we add this as a requirement when preparing
        reports?</p>
      </section>
    </section>
    <section>
      <h2>Security Considerations</h2>
      <section>
        <h3>Cascading Style Sheet (CSS) Parsing</h3>

        <p>The <code>style-src</code> directive restricts the locations from
        which a document can load styles. However, if the user agent uses a
        lax CSS parsing algorithm, an attacker might be able to trick the user
        agent into accepting malicious "stylesheets" hosted by an otherwise
        trustworthy origin.</p>

        <p>These attacks are similar to the <a
        href="http://scarybeastsecurity.blogspot.com/2009/12/generic-cross-browser-cross-domain.html">CSS
        cross-origin data leakage</a> attack described by Chris Evans in 2009.
        User agents SHOULD defend against both attacks using the same
        mechanism: stricter CSS parsing rules for stylesheets with improper
        MIME types.</p>
      </section>
    </section>
    <section>
      <h2>Implementation Considerations</h2>
      <section>
        <h3>Servers</h3>

        <p>Some servers might wish to combine multiple Content Security
        Policies (e.g., from multiple components in a single document).
        Servers SHOULD use the following algorithm to combine policies:</p>

        <ol>
          <li>TODO</li>
        </ol>

        <h3>Internet Service Providers</h3>

        <p>Some Internet service providers manipulate resources as they travel
        across their networks [TODO: Citation needed]. It's possible that these
        manipulations can cause a site to violate its Content Security Policy.</p>

        <p>Internet server providers SHOULD NOT manipulate resources as they
        travel across their networks. If Internet Service Providers persist in
        manipulating these resources, servers SHOULD employ transport-layer
        security, such as HTTPS, to ensure the integrity of their site over
        hostile networks.</p>
      </section>
    </section>
  </body>
</html>
